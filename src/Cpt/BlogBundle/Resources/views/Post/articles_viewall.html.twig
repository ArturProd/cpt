{##############################################################################}
{# JAVASCRIPT
{##############################################################################}
{#****************************************************************************#}
{# Includes common comment handling javascript
{#****************************************************************************#}
{% include 'CptBlogBundle:Post:comments.js.twig' %}

<script type="text/javascript">

var post_list = [Â ];    {# the actual post list (retreived from ajax request #}
var post_pager = [ ];   {# data used to paginate the post list (retreived from ajax request) #}
var pagination_currentpage = 1;
var pagination_currentfirstshown = 1;
var pagination_lastpage = 1;
var pagination_maxlinks = 1;

count_article_loaded = 0;
{#****************************************************************************#}
{# Show or hide an article
{#****************************************************************************#}
function toogle_article(id,speed)
{
    {# closing an article => all article get closed #}
    {# opening an article => only this article gets open #}
     visible = $("#post_body"+id).is(":visible");
        
        if (!visible)
        {
            $( "#comment_section" + id).slideDown(speed);
            $( "#post_body" + id ).slideDown(speed);
        }
        else
        {
            $( "#comment_section" + id).slideUp(speed);
            $( "#post_body" + id ).slideUp(speed);            
        }
        
    for (i = 0; i<post_list.length; ++i)
    {
        if (post_list[i].id!==id)
        {
            $( "#comment_section" + post_list[i].id).slideUp(speed);
            $( "#post_body" + post_list[i].id ).slideUp(speed);
        }
    }
}

{#**************************************************************************#}
{# Retreives an array of post id from server, and call getAndAddPost
{#**************************************************************************#}
function getPostList(page){

    count_article_loaded = 0;

    $('#articles').empty();
    $('#articles').hide();
    $('#homepage_aticles').hide();
    $('#loadingarticles').hide().fadeIn(2000);
    $('#postpagination').hide();
    

    $.getJSON( "{{ url('cpt_blog_getarticlelist') }}", {page:page}, function( response ) {
        if (response.status!=="ok")
            return;
        
        post_list = response.data.posts;
        post_pager = response.data.pager;
        for(i = 0; i<post_list.length ; ++i)
            getAndAddPost(post_list[i]);
        
        CreatePagination();
   });
}

{#**************************************************************************#}
{# Retreives the html view of a post from a server based on its id, and add it to the DOM
{#**************************************************************************#}
function getAndAddPost(post)
{
   {# if the post container already exists, delete it #}
   //if ($('postcontainer'+post.id)!==null)
    $('#postcontainer'+post.id).remove();
    
   {# add the div container for this post #}
    if (post.publishhomepage)
    { {# "A la une" posts #}
        jQuery('<div/>', {
            id: 'postcontainer'+post.id,
            class: 'postcontainer'
        }).appendTo('#homepage_aticles');
    }
    else
    { {# Other posts #}
        jQuery('<div/>', {
            id: 'postcontainer'+post.id,
            class: 'postcontainer'
        }).appendTo('#articles');                
    }
    {# retreive post view from server and add it to container #}
    $.get( "{{ url('cpt_blog_post_getjsonview') }}", {id:post.id} , function( response ) {
        if (response.status === "ok")
            $( "#postcontainer" + post.id ).html( response.data );
        
        {# if this is the last one to be retreive, prepare the accordion #}
        count_article_loaded ++;
        if (count_article_loaded === post_list.length) {# finished loading all articles #}
        {
            toogle_article(post_list[0].id,0);
            $('#articles').show();
            $('#homepage_aticles').show();
            $('#loadingarticles').hide();
            $('#postpagination').show();
        }
    });
}
{# ***************************************************************************#} 
{# Show or hide article popup
{#****************************************************************************#}     
function ArticlePopupDisplay(visible)
{
    DisplayOpacityMask(visible);

    if (visible)
    {
        $("#popup_new_article").show();
        window.scrollTo(0, 0);
    }
    else
        $("#popup_new_article").hide();
}
{#****************************************************************************#}
{# Loads the post popup with a given html content
{#****************************************************************************#}
function load_post_popup(html)
{
        $("#popup_new_article").html(html);
        ArticlePopupDisplay(true);
        window.scrollTo(0, 0);    
}
{#****************************************************************************#}
{# Loads the popup to Create or Modify an article. Pass null as postid to create a new article
{#****************************************************************************#}
function EditPost(postid)
{
    $.getJSON('{{ url('cpt_blog_post_edit')}}', {postid:postid}, function(response) {
        load_post_popup(response.data);
    }); 
}
{#****************************************************************************#}
{# Creates pagination links
{#****************************************************************************#}
function CreatePagination()
{
    $('#postpagination').empty();
    
    {# if we have to display the pagination bar #}
    if (post_pager.havetopaginate)
    {
        if (pagination_currentfirstshown !== post_pager.firstpage) {# if we are not already showing the first page, show the left arrow #}
        {
            listitem = $('<li/>').html( "<a onclick='pagination_showpreviouslinks();'></a>");
            listitem.addClass('post_pagination_leftarrow').appendTo('#postpagination');
        }
        else
            $('<li/>').appendTo('#postpagination');
        
        last_displayed_page = pagination_getlastdisplayedlink();
        
        for (i=pagination_currentfirstshown;i<last_displayed_page;++i) {# display the navigation links #}
        {
            listitem = $('<li/>', {

            }).html( "<a href='#' onclick='getPostList(" + i + ");'>" + i + "</a>");
            
            if (i===post_pager.page)
                listitem.addClass("post_pagination_currentpage");
        
            listitem.appendTo('#postpagination');
        
        }
        
        if (last_displayed_page < post_pager.lastpage) {# if the link to last page is not already displayed, display the right arrow #}
            {
                listitem = $('<li/>').html( "<a onclick='pagination_shownextlinks();'></a>");
                listitem.addClass("post_pagination_rightarrow").appendTo('#postpagination');
            }
        else
            $('<li/>').appendTo('#postpagination');
        
    }
}
{#****************************************************************************#}
{# Shifts pagination links to show the next pages in the pagination bar
{#****************************************************************************#}
function pagination_shownextlinks()
{
    if (pagination_getlastdisplayedlink()<post_pager.lastpage)
    {
        pagination_currentfirstshown++;
        CreatePagination();    
    }
}
{#****************************************************************************#}
{# Shifts pagination links to show the previous pages in the pagination bar
{#****************************************************************************#}
function pagination_showpreviouslinks()
{
    if (pagination_currentfirstshown>1)
    {
        pagination_currentfirstshown--;
        CreatePagination();
    }
}
{#****************************************************************************#}
{# Shifts pagination links to show the previous pages in the pagination bar
{#****************************************************************************#}
function pagination_getlastdisplayedlink()
{
        return Math.min(pagination_currentfirstshown+post_pager.maxpagelinks, post_pager.lastpage);    
}
{#**************************************************************************#}
{# Onload
{#**************************************************************************#}
$(function() {
    getPostList(1);

    {% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}        
    {# Articles Dialog Setup #}
    $("a#newarticle").on("click", function(){
        EditPost(null);
   });

    ArticlePopupDisplay(false);
    {% endif %}
});
</script>
{#
{#
{##############################################################################}
{# HTML
{##############################################################################}
 <div class="main_section">        
    <div class="column_title_article">
        {{'main.title.articles'|trans}}
        {% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}
            <a id='newarticle' class="article_new_btn">{{'main.button.new'|trans}}</a>
        {% endif %}
    </div>
    {#**************************************************************************#}
    {# A la une
    {#**************************************************************************#}
    <div class="alaune_label">{{ "article.alaune_label"|trans }}</div>
    <div id="homepage_aticles">
    {# preview_post.html.twig => loaded and appened by ajax request #}
    </div>
    {#**************************************************************************#}
    {# Separator
    {#**************************************************************************#}
    <div>
        <hr class="alaune"/>
        <div class="post_date_label">Date</div>
        <div class="post_titre_label">Titre</div>
        <div class="post_commentcount_label">Commentaires</div>
    </div>
    {#**************************************************************************#}
    {# All other articles
    {#**************************************************************************#}
    <div id="articles">
        {# preview_post.html.twig => loaded and appened by ajax request #}
    </div>
    <ul id="postpagination" class="post_pagination">
    </ul>
    {#**************************************************************************#}
    {# Ajax Loading icon
    {#**************************************************************************#}
    <div id="loadingarticles" class="loading">
        Loading articles...
    </div>
</div>
{#**************************************************************************#}
{# Popup to create and edit an article
{#**************************************************************************#}
{% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}
<div id="popup_new_article">
</div>
{% endif %}